dependencies:
  override:
  - mvn --fail-never dependency:go-offline || true
  - (cd v1x1-web && npm install)
  - pip install awscli
test:
  override:
  - mvn integration-test -Denvironment=prod
  - (cd v1x1-web && npm run build)
  post:
    - sudo mkdir -p /etc/docker/certs.d/registry.tblflp.zone:5443
    - sudo wget -O /etc/docker/certs.d/registry.tblflp.zone:5443/ca.crt http://pki.tblflp.zone/Tableflippers-Anonymous-Root-CA.pem
    - cat /etc/ssl/certs/ca-certificates.crt | sudo tee -a /etc/docker/certs.d/registry.tblflp.zone:5443/ca.crt
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS registry.tblflp.zone:5443
    - ./upload.sh
    - echo '#!/bin/bash' > codedeploy/v1x1-login.sh
    - echo "docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS registry.tblflp.zone:5443" >> codedeploy/v1x1-login.sh
    - chmod +x codedeploy/v1x1-login.sh
    - codedeploy/prepare.sh
machine:
  services:
  - docker
deployment:
#  hub:
#    branch: master
#    commands:
#    - sudo mkdir -p /etc/docker/certs.d/registry.tblflp.zone:5443
#    - sudo wget -O /etc/docker/certs.d/registry.tblflp.zone:5443/ca.crt http://pki.tblflp.zone/Tableflippers-Anonymous-Root-CA.pem
#    - cat /etc/ssl/certs/ca-certificates.crt | sudo tee -a /etc/docker/certs.d/registry.tblflp.zone:5443/ca.crt
#    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS registry.tblflp.zone:5443
#    - ./upload.sh
#  prod_prep:
#    branch: master
#    commands:
#    - echo '#!/bin/bash' > codedeploy/v1x1-login.sh
#    - echo "docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS registry.tblflp.zone:5443" >> codedeploy/v1x1-login.sh
#    - chmod +x codedeploy/v1x1-login.sh
#    - codedeploy/prepare.sh
  prod:
    branch: master
    codedeploy:
      v1x1:
        deployment_group: prod
        deployment_config: CodeDeployDefault.AllAtOnce
